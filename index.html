<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- Mobile Usability: Removed user-scalable=no, added safe-area handling -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- Security: Balanced CSP for Vue/Leaflet/Tailwind CDN -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        base-uri 'self';
        object-src 'none';
        frame-ancestors 'none';
        form-action 'self';
        connect-src 'self' https://script.google.com https://script.googleusercontent.com;
        img-src 'self' data: blob: https://*.basemaps.cartocdn.com https://unpkg.com https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org;
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com https://fonts.googleapis.com https://cdnjs.cloudflare.com;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com;
    ">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <meta name="apple-mobile-web-app-title" content="Travel Guide">
    <meta name="application-name" content="Travel Guide">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ECEDEA">
    <title>Travel Guide</title>

    <!-- Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImdyYWQyIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojQzhBN0ExO3N0b3Atb3BhY2l0eToxIiAvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6I0IyOTg5NDtzdG9wLW9wYWNpdHk6MSIgLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0idXJsKCNncmFkMikiLz48IS0tIFRvd2VyIEdyYXBoaWMgLS0+PHBhdGggZD0iTTI1NiAxMjAgTDI1NiAzNjAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMTgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxwYXRoIGQ9Ik0yMjAgMzYwIEwyOTIgMzYwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjE8IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyMjAiIHI9IjM1IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjE1IiBmaWxsPSJub25lIi8+PHRleHQgeD0iNTAlIiB5PSI0NDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXdlaWdodD0iODAwIiBmb250LXNpemU9IjY1IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgbGV0dGVyLXNwYWNpbmc9IjQiPlNFT1VMPC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNDkwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjMwMCIgZm9udC1zaXplPSIzNSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjgpIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBsZXR0ZXItc3BhY2luZz0iOCI+MjAyNjwvdGV4dD48L3N2Zz4=">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImdyYWQyIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojQzhBN0ExO3N0b3Atb3BhY2l0eToxIiAvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6I0IyOTg5NDtzdG9wLW9wYWNpdHk6MSIgLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0idXJsKCNncmFkMikiLz48IS0tIFRvd2VyIEdyYXBoaWMgLS0+PHBhdGggZD0iTTI1NiAxMjAgTDI1NiAzNjAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMTgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxwYXRoIGQ9Ik0yMjAgMzYwIEwyOTIgMzYwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjE8IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyMjAiIHI9IjM1IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjE1IiBmaWxsPSJub25lIi8+PHRleHQgeD0iNTAlIiB5PSI0NDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXdlaWdodD0iODAwIiBmb250LXNpemU9IjY1IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgbGV0dGVyLXNwYWNpbmc9IjQiPlNFT1VMPC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNDkwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjMwMCIgZm9udC1zaXplPSIzNSIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjgpIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBsZXR0ZXItc3BhY2luZz0iOCI+MjAyNjwvdGV4dD48L3N2Zz4=">
    
    <!-- 1. Configure Tailwind BEFORE loading the CDN -->
    <script>
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', '-apple-system', 'SF Pro Display', 'Segoe UI', 'Noto Sans TC', 'sans-serif'],
                            hand: ['Nanum Pen Script', 'cursive'],
                        },
                        colors: {
                            'm-bg': '#ECEDEA', 'm-card': '#F4F5F2',
                            'typo-label': '#B6B8B3', 
                            'typo-title': '#2E2E2E', 
                            'typo-accent': '#C9A6A1', 
                            'm-text': '#484846', 'm-sub': '#757573', 'm-border': 'rgba(200,204,199,0.3)',  
                            's-pin': '#C8A7A1', 's-alert': '#B0726B', 's-warn': '#C9B56A', 's-green': '#8FA39D', 's-blue': '#8E9AAF', 's-sand': '#D6C0B3',      
                        },
                        letterSpacing: { 'context': '0.12em', 'calm': '0.03em' },
                        boxShadow: {
                            'ios-card': '0 8px 24px -6px rgba(0, 0, 0, 0.04)',
                            'ios-float': '0 20px 40px -12px rgba(47, 47, 45, 0.08)',
                            'ios-sheet': '0 -12px 30px rgba(0, 0, 0, 0.06)',
                        },
                        spacing: {
                            'safe-top': 'env(safe-area-inset-top)', 'safe-bottom': 'env(safe-area-inset-bottom)',
                        }
                    }
                }
            }
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue & Leaflet -->
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+TC:wght@400;500;700&family=Nanum+Pen+Script&display=swap" rel="stylesheet">

    <style>
        :root { -webkit-tap-highlight-color: transparent; }
        body { background-color: #ECEDEA; color: #2E2E2E; -webkit-font-smoothing: antialiased; overscroll-behavior: none; }
        .no-select { user-select: none; -webkit-user-select: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-header {
            background: rgba(244, 245, 242, 0.75); 
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-tab {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 700;
            color: #757573;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
            cursor: pointer;
        }
        .modal-tab.active {
            color: #2E2E2E;
            border-bottom-color: #C9A6A1;
        }

        .segment-pill-active { background: rgba(120, 125, 120, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.45); color: #2E2E2E; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .segment-pill-inactive { background: transparent; color: #757573; border: 1px solid transparent; }
        .leaflet-tile-pane { filter: grayscale(0.2) sepia(0.05) contrast(0.95) brightness(1.02); }
        .custom-marker-pin { width: 32px; height: 32px; border-radius: 50% 50% 50% 0; background: #C8A7A1; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px; box-shadow: 0 5px 14px rgba(182, 106, 99, 0.25); border: 2px solid #F4F5F2; transition: all 0.4s cubic-bezier(0.2, 1, 0.4, 1); }
        .custom-marker-pin::after { content: ''; width: 8px; height: 8px; margin: 10px 0 0 10px; background: rgba(244, 245, 242, 0.9); position: absolute; border-radius: 50%; }
        .leaflet-marker-icon.active .custom-marker-pin { transform: rotate(-45deg) scale(1.18) translateY(-4px); background: #2E2E2E !important; border-color: #ECEDEA; }
        .timeline-line { background: linear-gradient(to bottom, #D6D8D4 0%, #C9CCC6 100%); }
        .notebook-modal { background-color: #F4F5F2; background-image: linear-gradient(#E5E7E4 1px, transparent 1px); background-size: 100% 2.2rem; }
        .notebook-textarea { background: transparent; width: 100%; height: 100%; border: none; outline: none; resize: none; line-height: 2.2rem; font-family: 'Noto Sans TC', sans-serif; font-size: 1.05rem; color: #484846; padding-top: 0.2rem; }
        .sync-input { background: #F4F5F2; border: 1px solid #D6D8D4; padding: 10px 14px; border-radius: 12px; font-family: 'Inter', sans-serif; font-size: 14px; color: #2E2E2E; width: 100%; outline: none; transition: border-color 0.2s; }
        .sync-input:focus { border-color: #C9A6A1; }
        .save-indicator-enter-active, .save-indicator-leave-active { transition: opacity 0.3s; }
        .save-indicator-enter-from, .save-indicator-leave-to { opacity: 0; }
        
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in-up 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .slide-up-enter-active, .slide-up-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { opacity: 0; transform: translateY(20px); }
        
        /* FIX: Map Container Absolute Positioning to prevent collapse */
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
    </style>
</head>
<body class="h-[100dvh] w-full overflow-hidden bg-m-bg">

    <div id="app" class="w-full h-full flex flex-col-reverse md:flex-row relative">
        <!-- Left Panel: Itinerary -->
        <div class="w-full h-[65%] md:h-full md:w-[480px] lg:w-[550px] flex flex-col bg-m-card relative z-20 shadow-ios-sheet md:shadow-2xl rounded-t-[2.5rem] md:rounded-none overflow-hidden transition-all duration-300">
            <!-- Mobile Handle -->
            <div class="w-full flex justify-center pt-3 pb-2 md:hidden bg-m-card/90 backdrop-blur-sm z-50 no-select"><div class="w-10 h-1 bg-m-border rounded-full"></div></div>
            
            <!-- Header -->
            <div class="glass-header px-6 flex-none z-40 pt-safe-top no-select">
                <div class="pt-2 md:pt-6 flex justify-between items-end mb-5">
                    <div class="flex flex-col">
                        <div class="text-[10px] font-normal tracking-[0.14em] text-typo-label uppercase mb-1">
                            {{ currentTripTitle || 'SEOUL TRAVEL GUIDE' }}
                        </div>
                        <div class="flex items-baseline gap-3">
                            <h1 class="text-[32px] font-medium text-typo-title tracking-[0.02em] font-sans leading-none truncate max-w-[200px]">
                                {{ currentTripId?.split('_')[0] || 'Seoul' }}
                            </h1>
                            <span class="font-hand text-[28px] text-typo-accent font-normal leading-none transform translate-y-[1px]">
                                {{ currentTripId?.split('_')[1] || '2026' }}
                            </span>
                        </div>
                    </div>
                    <div class="flex gap-3 mb-0.5">
                        <button type="button" aria-label="Reset Map" @click="resetMap" class="w-10 h-10 rounded-full bg-m-card shadow-ios-card border border-white/50 flex items-center justify-center text-m-sub active:scale-95 transition-transform"><i class="fa-solid fa-location-crosshairs"></i></button>
                        <button type="button" aria-label="Settings" @click="showSync = true" class="w-10 h-10 rounded-full bg-transparent flex items-center justify-center text-m-border hover:text-m-sub active:scale-95 transition-colors"><i class="fa-solid fa-gear"></i></button>
                        <button ref="openNoteBtn" type="button" aria-label="Open Notes" @click="openNotebook" class="flex items-center gap-2 bg-typo-title px-5 py-2.5 rounded-full shadow-lg shadow-typo-title/10 active:scale-95 transition-transform"><i class="fa-solid fa-pen-nib text-m-bg text-xs"></i><span class="text-xs font-bold text-m-bg hidden sm:block tracking-wide">Notes</span></button>
                    </div>
                </div>
                <div class="flex overflow-x-auto hide-scroll gap-2 pb-4 snap-x -mx-6 px-6 items-center">
                    <button type="button" v-for="(day, index) in schedule" :key="index" @click="selectDay(index)" :ref="(el) => { if(el) dayRefs[index] = el }" class="snap-start flex-shrink-0 px-4 py-2 rounded-full text-[13px] font-bold transition-all duration-300" :class="currentDayIndex === index ? 'segment-pill-active scale-[1.02]' : 'segment-pill-inactive'">Day {{ index + 1 }}</button>
                </div>
            </div>

            <!-- Content Area -->
            <div ref="timelineContainerRef" id="timeline-container" class="flex-1 overflow-y-auto hide-scroll p-6 pb-24 bg-m-card relative">
                <div v-if="initLoading" class="absolute inset-0 flex items-center justify-center z-50 bg-m-card/80 backdrop-blur-sm">
                    <div class="text-center">
                        <i class="fa-solid fa-cloud-arrow-down text-2xl text-typo-accent mb-2 animate-bounce"></i>
                        <div class="text-xs font-bold text-m-sub">Loading...</div>
                    </div>
                </div>

                <div v-if="currentDay" class="mb-10 animate-fade-in">
                    <div class="flex items-baseline gap-3 mb-2">
                        <h2 class="text-3xl font-medium text-typo-title tracking-calm font-sans">{{ currentDay.date?.split(' ')[0] }}</h2>
                        <span class="text-sm font-medium text-m-sub">{{ currentDay.date?.split(' ').slice(1).join(' ') }}</span>
                    </div>
                    <p class="text-lg font-medium text-m-text mb-8 leading-relaxed opacity-90">{{ currentDay.title }}</p>
                    
                    <!-- Meal Grid -->
                    <div class="grid grid-cols-3 gap-2 mb-8 no-select">
                        <div @click="openMealMap('lunch')" class="bg-white/60 p-3 rounded-2xl border border-m-border flex flex-col items-center justify-center gap-1 backdrop-blur-sm shadow-ios-card text-center cursor-pointer active:scale-95 transition-transform hover:bg-white/80 group">
                            <div class="w-8 h-8 rounded-full bg-s-sand/20 text-s-sand flex items-center justify-center text-xs flex-none group-hover:scale-110 transition-transform"><i class="fa-solid fa-utensils"></i></div>
                            <div class="overflow-hidden w-full">
                                <div class="text-[9px] text-m-sub uppercase font-bold tracking-wider mb-0.5">Lunch</div>
                                <div class="text-[10px] font-bold text-m-text truncate">{{ currentDay.lunch }}</div>
                            </div>
                        </div>
                        <div @click="openMealMap('tea')" class="bg-white/60 p-3 rounded-2xl border border-m-border flex flex-col items-center justify-center gap-1 backdrop-blur-sm shadow-ios-card text-center cursor-pointer active:scale-95 transition-transform hover:bg-white/80 group">
                            <div class="w-8 h-8 rounded-full bg-s-warn/20 text-s-warn flex items-center justify-center text-xs flex-none group-hover:scale-110 transition-transform"><i class="fa-solid fa-mug-hot"></i></div>
                            <div class="overflow-hidden w-full">
                                <div class="text-[9px] text-m-sub uppercase font-bold tracking-wider mb-0.5">Tea</div>
                                <div class="text-[10px] font-bold text-m-text truncate">{{ currentDay.tea || '_______' }}</div>
                            </div>
                        </div>
                        <div @click="openMealMap('dinner')" class="bg-white/60 p-3 rounded-2xl border border-m-border flex flex-col items-center justify-center gap-1 backdrop-blur-sm shadow-ios-card text-center cursor-pointer active:scale-95 transition-transform hover:bg-white/80 group">
                            <div class="w-8 h-8 rounded-full bg-s-blue/20 text-s-blue flex items-center justify-center text-xs flex-none group-hover:scale-110 transition-transform"><i class="fa-solid fa-moon"></i></div>
                            <div class="overflow-hidden w-full">
                                <div class="text-[9px] text-m-sub uppercase font-bold tracking-wider mb-0.5">Dinner</div>
                                <div class="text-[10px] font-bold text-m-text truncate">{{ currentDay.dinner }}</div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentDay.notice" class="p-5 rounded-2xl bg-s-alert/5 border border-s-alert/15 flex gap-3 items-start"><i class="fa-solid fa-circle-info text-s-alert mt-0.5 text-sm flex-none opacity-80"></i><div class="text-xs text-m-text leading-[1.85] font-medium whitespace-pre-line select-text" v-html="formatNote(currentDay.notice)"></div></div>
                </div>

                <!-- Timeline -->
                <div v-if="displayEvents" class="relative pl-2 space-y-10">
                    <div class="absolute left-[19px] top-4 bottom-4 w-[2px] timeline-line rounded-full opacity-50"></div>
                    <div v-for="(event, eIndex) in displayEvents" :key="event.id" :id="'event-' + event.id" @click="focusEvent(event.id)" @keydown.enter.prevent="focusEvent(event.id)" @keydown.space.prevent="focusEvent(event.id)" tabindex="0" role="button" class="relative pl-10 group cursor-pointer active:scale-[0.99] transition-transform duration-300 rounded-[1.8rem] outline-none focus-visible:outline-none">
                        <div class="absolute left-0 top-7 w-[12px] h-[12px] rounded-full border-[2px] border-m-card shadow-sm z-10 transition-all duration-300 ring-4 ring-m-card" :class="[getDotColor(event.category), activeEventId === event.id ? 'scale-125 bg-typo-title border-typo-title shadow-lg' : '']"></div>
                        <div class="bg-white p-6 rounded-[1.8rem] shadow-ios-card border border-white/80 relative overflow-hidden transition-all duration-400 group-focus-visible:ring-2 group-focus-visible:ring-typo-title/20 group-focus-visible:ring-offset-2 group-focus-visible:ring-offset-m-card" :class="activeEventId === event.id ? 'ring-1 ring-typo-title/10 bg-white' : ''">
                            <div class="flex justify-between items-center mb-3 no-select">
                                <span class="font-mono text-[11px] font-bold text-m-sub bg-m-bg px-2.5 py-1 rounded-lg tracking-tight">{{ event.time }}</span>
                                <span class="text-[9px] font-bold px-2.5 py-1 rounded-full uppercase tracking-widest text-white/85 shadow-sm" :class="getCategoryBadge(event.category)">{{ event.category }}</span>
                            </div>
                            <div class="flex justify-between items-start gap-2 mb-3">
                                <h3 class="text-[17px] font-medium text-typo-title leading-snug tracking-calm select-text">{{ event.location }}</h3>
                                <div class="flex gap-2">
                                    <button type="button" @click.stop="openMapService(event)" class="flex-none w-7 h-7 rounded-full bg-m-bg hover:text-white flex items-center justify-center transition-colors active:bg-m-border focus:outline-none focus:ring-2 focus:ring-typo-title/20 group" :class="countrySetting === 'KR' ? 'text-[#03C75A] hover:bg-[#03C75A]' : 'text-[#4285F4] hover:bg-[#4285F4]'" :title="countrySetting === 'KR' ? 'Naver Map' : 'Google Maps'">
                                        <span class="font-black text-[10px]" v-if="countrySetting === 'KR'">N</span>
                                        <i class="fa-brands fa-google text-[10px]" v-else></i>
                                    </button>
                                    <button type="button" @click.stop="copyText(event.location)" class="flex-none w-7 h-7 rounded-full bg-m-bg text-m-sub hover:text-typo-title flex items-center justify-center transition-colors active:bg-m-border focus:outline-none focus:ring-2 focus:ring-typo-title/20"><i class="fa-regular fa-copy text-xs"></i></button>
                                </div>
                            </div>
                            <div v-if="event.note" class="text-[13.5px] text-m-text leading-[1.85] bg-m-bg/40 p-4 rounded-xl border border-m-border select-text" v-html="formatNote(event.note)"></div>
                            <div v-if="event.tags" class="mt-4 flex flex-wrap gap-2 no-select"><span v-for="tag in event.tags" class="text-[10px] px-2.5 py-1 rounded-md font-bold tracking-wide" :class="getTagStyle(tag)">#{{ tag }}</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Map -->
        <div class="w-full flex-1 relative z-0 md:z-auto bg-m-bg overflow-hidden relative">
            <!-- FIX: Added relative to parent and absolute to map to force height -->
            <div id="map"></div>
            <div v-if="mapError" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-m-bg/90 p-6 text-center animate-fade-in">
                <i class="fa-solid fa-map-location-dot text-4xl text-m-sub mb-4"></i>
                <p class="text-m-text font-bold mb-2">Map Unavailable</p>
                <button @click="retryMap" class="px-4 py-2 bg-typo-title text-white rounded-lg text-xs font-bold hover:opacity-90 transition-opacity">Retry</button>
            </div>
            <div class="absolute bottom-8 right-8 z-[500] bg-white/70 backdrop-blur-md px-5 py-4 rounded-3xl shadow-ios-float hidden md:block border border-white/40 no-select">
                <div class="text-[9px] font-bold text-typo-label uppercase mb-3 tracking-[0.2em]">Map Index</div>
                <div class="space-y-2.5"><div v-for="(config, key) in mapLegendItems" :key="key" class="flex items-center gap-3 text-xs font-bold text-m-text"><span class="w-2.5 h-2.5 rounded-full shadow-sm" :style="{ backgroundColor: config.color }"></span> {{ config.label }}</div></div>
            </div>
        </div>

        <!-- Notebook Modal -->
        <transition name="slide-up">
            <div v-if="showNotebook" class="fixed inset-0 z-[2000] flex items-end md:items-center justify-center bg-typo-title/15 backdrop-blur-[2px] notebook-overlay" @click.self="closeNotebook" role="dialog" aria-modal="true">
                <div class="bg-m-card w-full md:w-[600px] h-[85vh] md:h-[70vh] rounded-t-[2.5rem] md:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden ring-1 ring-white/50 notebook-modal-container" @keydown.tab.prevent="trapFocus">
                    <div class="px-6 py-5 bg-m-card border-b border-m-border flex justify-between items-center flex-none">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-pen-nib text-typo-title"></i><span class="font-bold text-typo-title text-lg">Trip Notes</span></div>
                        <div class="flex items-center gap-4">
                            <transition name="save-indicator"><span v-if="saveStatus === 'Saved'" class="text-[10px] font-bold text-s-green uppercase tracking-wider bg-s-green/10 px-2 py-1 rounded-md"><i class="fa-solid fa-check mr-1"></i>Saved</span></transition>
                            <button ref="closeNoteBtn" type="button" aria-label="Close Notes" @click="closeNotebook" class="w-9 h-9 rounded-full bg-black/5 flex items-center justify-center text-m-text hover:bg-black/10 transition-colors focus:outline-none focus:ring-2 focus:ring-typo-title/20"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 notebook-modal p-8 overflow-y-auto"><textarea ref="noteTextarea" v-model="userNotes" @input="saveNotes" class="notebook-textarea" placeholder="Type here..."></textarea></div>
                </div>
            </div>
        </transition>

        <!-- Settings Modal -->
        <transition name="slide-up">
            <div v-if="showSync" class="fixed inset-0 z-[2000] flex items-center justify-center bg-typo-title/20 backdrop-blur-sm" @click.self="showSync = false">
                <div class="bg-white w-[90%] max-w-[420px] rounded-[2rem] shadow-2xl p-6 animate-fade-in border border-white/50 max-h-[85vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4 flex-none">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-gear text-typo-title"></i><span class="text-xl font-bold text-typo-title">Settings</span></div>
                        <button @click="showSync = false" class="w-8 h-8 rounded-full bg-m-bg flex items-center justify-center text-m-sub hover:text-typo-title"><i class="fa-solid fa-xmark"></i></button>
                    </div>

                    <!-- Standard CSS Tabs -->
                    <div class="flex gap-4 mb-4 border-b border-m-border pb-1">
                        <button @click="settingsTab = 'trips'" :class="['modal-tab', settingsTab === 'trips' ? 'active' : '']">â˜ï¸ Trips</button>
                        <button @click="settingsTab = 'ai'" :class="['modal-tab', settingsTab === 'ai' ? 'active' : '']">âœ¨ AI Tools</button>
                    </div>

                    <div class="flex-1 overflow-y-auto hide-scroll space-y-6">
                        <!-- TAB 1: TRIPS -->
                        <div v-if="settingsTab === 'trips'">
                            <div class="bg-m-card p-5 rounded-2xl border border-m-border mb-6">
                                <div class="text-[10px] font-bold text-typo-label uppercase mb-3 tracking-widest">Active Trip</div>
                                <div class="mb-4">
                                    <div class="text-sm font-bold text-m-sub mb-1">Trip ID</div>
                                    <input v-model="activeTripId" type="text" class="sync-input font-mono text-lg font-bold text-typo-title uppercase" placeholder="e.g. TOKYO_2027">
                                </div>
                                <div class="mb-4">
                                    <div class="text-sm font-bold text-m-sub mb-1">Map Region</div>
                                    <select v-model="countrySetting" class="sync-input">
                                        <option value="KR">Korea (NAVER Map)</option>
                                        <option value="GLOBAL">Global (Google Maps)</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <button @click="saveTrip" :disabled="syncLoading" class="py-3 px-4 rounded-xl bg-typo-title text-white font-bold text-sm active:scale-95 transition-transform disabled:opacity-50"><i class="fa-solid fa-cloud-arrow-up mr-2"></i>Backup</button>
                                    <button @click="fetchTripLibrary" :disabled="syncLoading" class="py-3 px-4 rounded-xl bg-white border border-m-border text-m-text font-bold text-sm active:scale-95 transition-transform disabled:opacity-50"><i class="fa-solid fa-rotate mr-2"></i>Cloud</button>
                                </div>
                                <div v-if="syncLog" class="mt-3 text-center text-xs font-bold" :class="syncLog.type === 'error' ? 'text-s-alert' : 'text-s-green'"><i v-if="syncLoading" class="fa-solid fa-spinner fa-spin mr-1"></i>{{ syncLog.message }}</div>
                            </div>

                            <div v-if="tripLibrary.length > 0">
                                <div class="text-[10px] font-bold text-typo-label uppercase mb-3 tracking-widest">Cloud Backups</div>
                                <div class="space-y-3 mt-2">
                                    <div v-for="trip in tripLibrary" :key="trip.tripId" class="bg-white p-4 rounded-2xl border border-m-border shadow-sm flex justify-between items-center group">
                                        <div class="overflow-hidden">
                                            <div class="text-sm font-bold text-typo-title truncate">{{ trip.title }}</div>
                                            <div class="text-xs font-mono text-m-sub mt-0.5">{{ trip.tripId }}</div>
                                        </div>
                                        <button @click="loadTrip(trip.tripId)" class="px-4 py-2 bg-s-sand/20 text-s-sand rounded-lg text-xs font-bold hover:bg-s-sand hover:text-white transition-colors">Load</button>
                                    </div>
                                </div>
                            </div>
                             <div v-else class="text-center py-8 text-m-sub text-sm bg-m-card/50 rounded-2xl border-dashed border border-m-border">
                                No backups found.<br>Connect GAS URL & Refresh.
                            </div>
                        </div>

                        <!-- TAB 2: AI TOOLS -->
                        <div v-if="settingsTab === 'ai'">
                            <div class="bg-m-card/50 p-5 rounded-2xl border border-m-border mb-6">
                                <div class="text-[10px] font-bold text-typo-label uppercase mb-3 tracking-widest flex items-center gap-2"><i class="fa-solid fa-robot"></i> AI Prompt Helper</div>
                                <textarea readonly class="sync-input text-xs font-mono mb-3 h-32 bg-white/50" :value="aiPromptTemplate"></textarea>
                                <button @click="copyPrompt" class="w-full py-2 rounded-xl bg-white border border-m-border text-m-text font-bold text-xs hover:bg-m-card transition-colors"><i class="fa-regular fa-copy mr-2"></i>Copy Prompt</button>
                                <div class="text-[9px] text-m-sub mt-2 text-center">Managed via Cloud ID: <code>__sys_prompt__</code></div>
                            </div>

                            <div class="bg-s-sand/10 p-5 rounded-2xl border border-s-sand/20">
                                <div class="text-[10px] font-bold text-typo-label uppercase mb-3 tracking-widest flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Import</div>
                                <textarea v-model="importJson" class="sync-input text-xs font-mono mb-3 h-24" placeholder="Paste Gemini JSON here..."></textarea>
                                <button @click="executeImport" class="w-full py-3 rounded-xl bg-typo-title text-white font-bold text-sm hover:bg-black transition-colors"><i class="fa-solid fa-file-import mr-2"></i>Import Schedule</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, nextTick, watch } = Vue;

        // --- Config ---
        const GAS_API_URL = ""; // âš ï¸ FILL THIS WITH YOUR DEPLOYED WEB APP URL âš ï¸

        const CATEGORY_CONFIG = {
            transport: { color: '#8FA39D', icon: 'bg-s-green', label: 'Transport', markerColor: '#8FA39D' },
            food:      { color: '#D6C0B3', icon: 'bg-s-sand',  label: 'Food',      markerColor: '#D6C0B3' },
            shopping:  { color: '#8E9AAF', icon: 'bg-s-blue',  label: 'Shopping',  markerColor: '#8E9AAF' },
            activity:  { color: '#C8A7A1', icon: 'bg-s-pin',   label: 'Activity',  markerColor: '#C8A7A1' },
            hotel:     { color: '#2F2F2D', icon: 'bg-typo-title', label: 'Hotel',  markerColor: '#2F2F2D' },
            flight:    { color: '#D6C0B3', icon: 'bg-s-sand',  label: 'Flight',    markerColor: '#D6C0B3' },
            alert:     { color: '#B0726B', icon: 'bg-s-alert', label: 'Important', markerColor: '#B0726B' },
            default:   { color: '#757573', icon: 'bg-m-sub',   label: 'Other',     markerColor: '#8E8E8C' }
        };

        const REGEX_NEWLINE = /\n/g;
        const REGEX_ICONS = /(âš ï¸|ğŸ’¡|ğŸ“|ğŸ•’|ğŸ’°|ğŸš‡|ğŸš•|ğŸšŒ|ğŸš¶|ğŸ§³|ğŸ›‘|âœˆï¸|ğŸš„|â˜•|ğŸ›ï¸)/g;
        const REGEX_KEYWORDS = /(æ­»ç·š|é¢¨éšª|é—œéµå‹•ä½œ|Plan A|Plan B|SOP)/g;
        
        const DEFAULT_AI_PROMPT = `è«‹æ‰®æ¼”è³‡æ·±è³‡æ–™å·¥ç¨‹å¸«ã€‚åˆ†ææˆ‘ä¸Šå‚³çš„è¡Œç¨‹è¡¨åœ–ç‰‡ï¼Œå°‡å…¶è½‰æ›ç‚ºç¬¦åˆä»¥ä¸‹è¦ç¯„çš„ JSON æ ¼å¼ã€‚
æ ¸å¿ƒè¦å‰‡:
1. Time: è½‰ç‚º "HH:MM" (24h)ã€‚
2. Category: transport, food, shopping, activity, hotel, flight, alert.
3. Map Term: è‹¥æœ‰éŸ“æ–‡åº—åå„ªå…ˆæå–ï¼›è‹¥ç„¡å‰‡å–æœ€ç¨ç‰¹çš„ä¸­è‹±æ–‡ã€‚
4. Structure: å¿…é ˆå®Œå…¨ç¬¦åˆ App çš„ SCHEDULE_DATA çµæ§‹ã€‚
5. Country: è«‹åœ¨ root å±¬æ€§åŠ å…¥ country: 'KR' (or 'JP' etc.)ã€‚
è¼¸å‡º JSON Arrayã€‚`;

        // Default Data Payload
        const DEFAULT_SCHEDULE = [
            {
                date: "06/01 (ä¸€) Day 1",
                title: "é«˜é›„â”é¦–çˆ¾(ç§»å‹•)ï¼‹é£¯åº—å®µå¤œ(1h)",
                lunch: "_______", lunchId: null, tea: "_______", teaId: null, dinner: "å¤–é€ (çµå¥‡å¹´ç³•/æ©‹æ‘ç‚¸é›)", dinnerId: "d1-e9",
                events: [
                    { id: "d1-e1", time: "12:00", location: "å®¶è£¡å‡ºç™¼ â” é«˜é›„å°æ¸¯æ©Ÿå ´ (KHH)", category: "transport", note: "ğŸ•’ æ™‚é–“ï¼šé è¨ˆ 12:00-12:30 å‡ºé–€ (ä¿ç•™ç·©è¡)", coords: [22.5768, 120.3478] },
                    { id: "d1-e2", time: "13:30", location: "æŠµé”æ©Ÿå ´ & è¾¦ç†ç™»æ©Ÿ (Check-in)", category: "flight", note: "âœˆï¸ èˆªç­ï¼šå°ç£è™èˆª (Tigerair Taiwan) IT662\nâš ï¸ å‹•ä½œï¼šæ‰˜é‹è¡Œæã€é ˜ç™»æ©Ÿè­‰ã€éå®‰æª¢", coords: [22.5768, 120.3478] },
                    { id: "d1-e3", time: "15:15", location: "ã€ç™»æ©Ÿæ™‚é–“ Boardingã€‘(èµ·é£›å‰ 40 åˆ†é˜)", category: "alert", note: "ğŸ“ å‹•ä½œï¼šå‰å¾€ç™»æ©Ÿé–€æº–å‚™æ’éšŠ\nâš ï¸ æ­»ç·šï¼šç™»æ©Ÿé–€é€šå¸¸æ–¼ 15:35 é—œé–‰ï¼Œè«‹å‹¿é²åˆ°", tags: ["æ­»ç·š"], coords: null },
                    { id: "d1-e4", time: "15:55", location: "èµ·é£› (å‰å¾€é¦–çˆ¾é‡‘æµ¦)", category: "flight", note: "", coords: null },
                    { id: "d1-e5", time: "19:40", location: "æŠµé”é‡‘æµ¦æ©Ÿå ´ (GMP)", category: "transport", note: "", coords: [37.5587, 126.8028] },
                    { id: "d1-e6", time: "20:30", location: "äº¤é€šï¼šé‡‘æµ¦æ©Ÿå ´ â” ä¹æ¨¹ ROKAUS é¾å±± (è¨ˆç¨‹è»Š)", category: "transport", note: "ğŸ•’ æ™‚é–“ï¼šä¿®æ­£ä¼° 45-60 åˆ†é˜ (ç´å…¥é€±ä¸€æ™šé–“å¡è»Šé¢¨éšª)\nğŸ’° è»Šè³‡ï¼šç´„ 25,000 éŸ“å…ƒèµ· (ä¾è·¯æ³æµ®å‹•)", coords: [37.5587, 126.8028] },
                    { id: "d1-e7", time: "20:50", location: "ã€é—œéµå‹•ä½œã€‘å«å¤–é€æ±ºç­–", category: "alert", note: "A. é †åˆ©ä¸Šè»Šï¼šåœ¨è¨ˆç¨‹è»Šä¸Šå« (é ä¼° 21:10 æŠµé”)\nB. å»¶èª¤/å¡è»Šï¼šæŠµé”é£¯åº—å†å« (æ”¹é»æ©‹æ‘ç‚¸é›ï¼Œè¼ƒè€æ”¾)", tags: ["é—œéµ"], coords: null },
                    { id: "d1-e8", time: "21:10", location: "æŠµé”é£¯åº— Check-in (å·²é 15:00 å¯ç›´æ¥å…¥æˆ¿)", category: "hotel", note: "", coords: [37.5293, 126.9654] },
                    { id: "d1-e9", time: "21:30", location: "å¤§å»³å–é¤åƒå®µå¤œ", category: "food", note: "ã€Plan Aã€‘çµå¥‡è¾£ç‚’å¹´ç³• (éœ€ 21:20 å‰ä¸‹å–®)\nã€Plan Bã€‘æ©‹æ‘ç‚¸é› (è‹¥è¶•ä¸ä¸Šå¹´ç³•æ”¹åƒé€™å€‹)", coords: [37.5293, 126.9654] }
                ]
            },
            {
                date: "06/02 (äºŒ) Day 2",
                title: "å¤¢ç¢³(2h)ï¼‹åŠ å±±Outlet(4h)",
                lunch: "å¤¢ç¢³ (ç‡’è‚‰)", lunchId: "d2-e4", tea: "_______", teaId: null, dinner: "_______", dinnerId: null,
                events: [
                    { id: "d2-e1", time: "10:00", location: "äº¤é€šï¼šé£¯åº— â” å¤¢ç¢³ (Mongtan / ëª½íƒ„)", category: "transport", note: "ğŸ“ åœ°å€ï¼šé¦–çˆ¾ é¾å±±å€ ç™½å‡¡è·¯99è¡— 50 (ì„œìš¸ ìš©ì‚°êµ¬ ë°±ë²”ë¡œ99ê¸¸ 50)\nğŸšŒ æ¨è–¦ï¼šå…¬è»Š (ç´„ 11 åˆ†é˜ / æœ€å¿«) â” [ä¸‰è§’åœ°ç«™] ä¸‹è»Š\nğŸš¶ å‚™æ¡ˆï¼šæ­¥è¡Œ (ç´„ 23 åˆ†é˜ / 1.4km / Naver Map é©—è­‰)", coords: [37.5372, 126.9698] },
                    { id: "d2-e2", time: "10:40", location: "ã€æ’éšŠé—œéµã€‘æŠµé”ç¾å ´æº–å‚™å€™ä½", category: "alert", note: "âš ï¸ è¦å‰‡ï¼š11:00 é–‹æ”¾ç¾å ´æ©Ÿå°ç™»è¨˜ (ä¸å¯æŒ‡å®šæ™‚é–“/ç„¡é ç´„)\nğŸ“‹ å‹•ä½œï¼š10:40 å‰æŠµé”å‘¨é‚Š â” 11:00 æº–æ™‚æ“ä½œæ©Ÿå°\nğŸ›‘ é¢¨éšªæ§ç®¡ï¼šè‹¥è™Ÿç¢¼éæ–¼é å¾Œ (éœ€ç­‰ 3hr+)ï¼Œç›´æ¥å•Ÿå‹•å‚™æ¡ˆåˆé¤", tags: ["é—œéµ", "é¢¨éšª"], coords: [37.5372, 126.9698] },
                    { id: "d2-e3", time: "ä¸Šåˆ", location: "é™„è¿‘å’–å•¡å»³ç­‰å¾… (_______ è‡ªè¡Œå°‹æ‰¾)", map_term: "Approach Coffee", category: "food", note: "", coords: [37.5288, 126.9715] },
                    { id: "d2-e4", time: "åˆé¤", location: "å¤¢ç¢³ (ç‡’è‚‰)", map_term: "ëª½íƒ„", category: "food", note: "ğŸ•’ ç‡Ÿæ¥­ï¼š12:00 é–‹å§‹å«è™Ÿå…¥åº§\nğŸ•’ é ä¼°åœç•™ï¼šç´„ 1.5 - 2 å°æ™‚", coords: [37.5372, 126.9698] },
                    { id: "d2-e5", time: "14:30", location: "ã€ç©ºçª—æœŸæ±ºç­–ï¼š14:30-16:00ã€‘(KPI å°å‘)", category: "alert", note: "ğŸ’¡ é¸é … A (å‘³é“é‡/éœ€è£œå¦)ï¼šå›é£¯åº— (15:30 å¿…é ˆå‡ºç™¼)\nğŸ’¡ é¸é … B (ç²¾ç¥ä½³)ï¼šAmore Pacific ç¸½éƒ¨ (15:40 å¿…é ˆé›¢é–‹)\nğŸ’¡ é¸é … C (äººæ½®ç„¦æ…®)ï¼šç›´æ¥ææ—©å» Outlet (æˆ°åŠ›æœ€å¼·åŒ–)", coords: [37.5293, 126.9654] },
                    { id: "d2-e6", time: "16:00", location: "äº¤é€šï¼šé¾å±±å€åŸŸ â” åŠ å±±æ•¸ç¢¼åœ’å€ (Gasan)", category: "transport", note: "ğŸš‡ åœ°éµï¼š1è™Ÿç·š [é¾å±±] â” [åŠ å±±æ•¸ç¢¼åœ’å€] (å¾€ä»å·/æ°´åŸæ–¹å‘)\nğŸ•’ æ™‚é–“ï¼šå…¨ç¨‹ç´„ 35-40 åˆ†é˜ (å«æ­¥è¡Œèˆ‡å€™è»Š)\n*è¨»ï¼šé£¯åº—æ­¥è¡Œè‡³è»Šç«™ç´„5åˆ†(ä¸»å‡ºå£)+ä¹˜è»Š19åˆ†+å‡ºç«™æ­¥è¡Œç´„10åˆ†", coords: [37.4815, 126.8826] },
                    { id: "d2-e7", time: "16:40", location: "ã€Mario Outletã€‘(é¦¬é‡Œå¥§ Outlet) 1/2/3é¤¨", category: "shopping", note: "ğŸ•’ ç‡Ÿæ¥­ï¼šå¹³æ—¥(é€±äºŒ) è‡³ 21:00 çµæŸç‡Ÿæ¥­\nâš ï¸ é€²å ´ SOPï¼š1.å…ˆæ‹æ¨“å±¤å°è¦½ 2.é–å®šç›®æ¨™å“ç‰Œæ¨“å±¤\n====== ğŸ›ï¸ è³¼ç‰©å‹•ç·š (çœåŠ›æœ€å¤§åŒ–) ======\nâ¶ [16:40-17:50] 2é¤¨ (Leisure)ï¼šå…ˆæ”»æ©Ÿèƒ½\n   â€¢ å°ˆæ”»ï¼šThe North Face (ä¸€èˆ¬ç·š), K2, Black Yak (æŠ˜æ‰£æ·±)\nâ· [17:50-19:20] 3é¤¨ (Mario Mall)ï¼šå†æ”»æ½®æµ\n   â€¢ å°ˆæ”»ï¼šMLB, Discovery, National Geographic (1F/2Fç‚ºä¸»)\nâ¸ [19:20-20:00] æ±ºç­–èˆ‡è¤‡é©—\n   â€¢ å‹•ä½œï¼šå›åˆ°å‘½ä¸­æ«ƒä½ç¢ºèªå°ºå¯¸/é¡è‰²ï¼Œé€²è¡Œçµå¸³\nâ¹ [20:00-20:30] æ™šé¤ (_______)", tags: ["æˆ°åŠ›å…¨é–‹"], coords: [37.4784, 126.8887] },
                    { id: "d2-e8", time: "20:30", location: "äº¤é€šï¼šåŠ å±±æ•¸ç¢¼åœ’å€ â” ä¹æ¨¹ ROKAUS é¾å±±", category: "transport", note: "ğŸš‡ åœ°éµï¼š1è™Ÿç·šç›´é” [é¾å±±ç«™] (ç´„ 35-40 åˆ†é˜)", coords: [37.5293, 126.9654] },
                    { id: "d2-e9", time: "21:15", location: "æŠµé”é£¯åº— (æ•´ç†å¤§é‡æˆ°åˆ©å“)", category: "hotel", note: "", coords: [37.5293, 126.9654] }
                ]
            },
            {
                date: "06/03 (ä¸‰) Day 3",
                title: "é¾ç†åœ˜è·¯(1.5h)ï¼‹ç‹é·—äº­(3.5h)ï¼‹æ¼¢å—æ´(3h)",
                lunch: "é¾ç†åœ˜è·¯æ—©åˆé¤", lunchId: "d3-e2", tea: "Milestone Coffee", teaId: "d3-e6", dinner: "æ¼¢å—æ´ 24H é¦¬éˆ´è–¯æ¹¯", dinnerId: "d3-e8",
                events: [
                    { id: "d3-e1", time: "09:30", location: "äº¤é€šï¼šé£¯åº— â” é¾ç†åœ˜è·¯ (æ—©åˆé¤æˆ°å€)", category: "transport", note: "ğŸ’¡ ç­–ç•¥ï¼šååº—ä½æ–¼ã€Œä¸‰è§’åœ°ç«™ã€é™„è¿‘ï¼Œé›¢é£¯åº—ç´„ 1.2kmï¼Œå»ºè­°æ­è»ŠçœåŠ›\nğŸš‡ åœ°éµï¼š4è™Ÿç·š [æ–°é¾å±±ç«™] â” [ä¸‰è§’åœ°ç«™] (æ­ 1 ç«™ / 3è™Ÿå‡ºå£)\nğŸšŒ å…¬è»Šï¼šè—è‰²å·´å£« 100/150/151 ç­‰ (æ­ 2 ç«™) â” [ä¸‰è§’åœ°ç«™]\nğŸš¶ æ­¥è¡Œï¼šæ²¿å¤§é¦¬è·¯ç›´èµ°ç´„ 20-25 åˆ†é˜ (6æœˆå¤©æ°£ç†±ï¼Œä¸å»ºè­°)", coords: [37.5312, 126.9705] },
                    { id: "d3-e2", time: "ä¸Šåˆ", location: "æ—©åˆé¤ååº—ã€ä¸‰é¸ä¸€ã€‘(çš†ä½æ–¼ä¸‰è§’åœ°ç«™å‘¨é‚Š)", category: "food", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 1.5 å°æ™‚ (å«å€™ä½èˆ‡ç”¨é¤)\nâ¶ Dotori (æ©¡å¯¦)ï¼šç‰¹è‰²å„ªæ ¼/æ©¡å¯¦éºµåŒ… (å¾’æ­¥ç´„ 3 åˆ†é˜)\nâ· SAM SAM SAMï¼šç¾å¼å¾©å¤å®¶å¸¸èœ (å¾’æ­¥ç´„ 3 åˆ†é˜)\nâ¸ Teddy Beurre Houseï¼šæ³•å¼å¯é Œååº— (å¾’æ­¥ç´„ 2 åˆ†é˜)", coords: [37.5312, 126.9705] },
                    { id: "d3-e3", time: "12:00", location: "äº¤é€šï¼šé¾ç†åœ˜è·¯ â” ç‹é·—äº­/ç¾…å¾·å¥§ (å–®æ¬¡æœ€é è·é›¢)", category: "transport", note: "ğŸš• å»ºè­°ï¼šè¨ˆç¨‹è»Š (è·¨å€æœ€å¿«)\nğŸ•’ æ™‚é–“ï¼šä¿®æ­£ä¼° 25-35 åˆ†é˜ (è¦–æ¼¢å—å¤§æ©‹è·¯æ³æµ®å‹•)\nğŸ’³ æ°£å€™å¡ï¼šåœ°éµ 4è™Ÿç·šè½‰ 3è™Ÿç·š [æ–°æ²™] (ç´„ 40 åˆ†é˜)", coords: [37.5273, 127.0392] },
                    { id: "d3-e4", time: "ä¸‹åˆ", location: "ç‹é·—äº­ / ç¾…å¾·å¥§ (å³¶å±±å…¬åœ’å‘¨é‚Š)ï¼šé€›ç²¾å“èˆ‡æ½®ç‰Œ", category: "shopping", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 3.5 - 4 å°æ™‚ (å€åŸŸè¼ƒå¤§ï¼Œå«ä¸‹åˆèŒ¶)", coords: [37.5273, 127.0392] },
                    { id: "d3-e5", time: "16:00", location: "äº¤é€šï¼šç‹é·—äº­ â” æ¼¢å—æ´ (ç·šæ€§å›ç¨‹)", category: "transport", note: "ğŸ’³ æ°£å€™å¡ï¼šå·´å£« 142 / 144 / 472 (é †å‘å›ç¨‹)\nğŸ•’ æ™‚é–“ï¼šå…¬è»Šç´„ 15-20 åˆ†é˜ + æ­¥è¡Œè‡³å•†åœˆç´„ 10 åˆ†é˜\nğŸš• å‚™æ¡ˆï¼šè¨ˆç¨‹è»Šç´„ 10-15 åˆ†é˜ (ç´„ 10,000 éŸ“å…ƒ)", coords: [37.5348, 127.0012] },
                    { id: "d3-e6", time: "ä¸‹åˆ", location: "æ¼¢å—æ´é€›è¡— & å’–å•¡å»³", category: "shopping", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 3 å°æ™‚ (å«é€›è¡—èˆ‡æ™šé¤)\nâ˜• **å’–å•¡æ¨è–¦ï¼šMilestone Coffee Hannam** (ë§ˆì¼ìŠ¤í†¤ì»¤í”¼ í•œë‚¨ì )\n   â€¢ ç‰¹è‰²ï¼šçŸ¥åç¶­ä¹Ÿç´å’–å•¡ã€ææ‹‰ç±³è˜‡ï¼Œæ°›åœæ¥µä½³\n   â€¢ ä½ç½®ï¼šæ¼¢å—æ´å··å¼„å…§ï¼Œé€›è¡—é€”ä¸­é©åˆä¼‘æ†©\n*è¨»ï¼šè‹¥ D2 å·²è²·å¤ æˆ¶å¤–ç‰Œï¼Œé€™è£¡å°ˆæ”»è¨­è¨ˆå¸«æ½®ç‰Œ (Mardi, Maritheç­‰)", coords: [37.5348, 127.0012] },
                    { id: "d3-e7", time: "19:30", location: "æ­¥è¡Œå‰å¾€ï¼šæ¼¢å—æ´ 24å°æ™‚é¦¬éˆ´è–¯æ’éª¨æ¹¯ (æˆ–å‘¨é‚Šæ™šé¤)", category: "transport", note: "", coords: [37.5332, 127.0028] },
                    { id: "d3-e8", time: "20:00", location: "æ™šé¤ï¼šæ¼¢å—æ´ 24å°æ™‚é¦¬éˆ´è–¯æ’éª¨æ¹¯", map_term: "24ì‹œë¼ˆë‹¤ê·€ê°ìíƒ•", category: "food", note: "", coords: [37.5332, 127.0028] },
                    { id: "d3-e9", time: "21:30", location: "äº¤é€šï¼šæ¼¢å—æ´ â” ä¹æ¨¹ ROKAUS é¾å±± (çŸ­ç¨‹æ”¶å°¾)", category: "transport", note: "ğŸ’³ æ°£å€™å¡ï¼šå·´å£« 400 / 110B (ç›´é”é£¯åº—é™„è¿‘)\nğŸ•’ æ™‚é–“ï¼šå…¬è»Šç´„ 20 åˆ†é˜ (Naver Map é©—è­‰)\nğŸš• å‚™æ¡ˆï¼šè¨ˆç¨‹è»Šç´„ 10 åˆ†é˜ (ç´„ 8,000 éŸ“å…ƒ)", coords: [37.5293, 126.9654] }
                ]
            },
            {
                date: "06/04 (å››) Day 4",
                title: "è‰åŸç‰§å ´(1.5h)ï¼‹é›æ’åˆé¤(1h)ï¼‹éµé“è‡ªè¡Œè»Š(1.5h)",
                lunch: "æ˜æ´è¾£ç‚’é›æ’", lunchId: "d4-e6", tea: "é¦¬éˆ´è–¯éºµåŒ… (å¤–å¸¶)", teaId: "d4-e5", dinner: "_______", dinnerId: null,
                notice: "====== âš ï¸ è¡Œå‰æº–å‚™ç¢ºèª ======\n1. [ç«è»Š] 5/4 æ—©ä¸Š 07:00 æº–æ™‚é–‹æ¶ ITX (å»:é¾å±±09:17 / å›:å—æ˜¥å·18:56å·¦å³)ã€‚\n2. [é ç´„] å‡ºç™¼å‰å®Œæˆã€Œæ˜¥å·å¤–åœ‹äººè§€å…‰è¨ˆç¨‹è»Šã€ç·šä¸Šé ç´„ã€‚\n3. [é«”é©—] å‡ºç™¼å‰ 2 é€±é ç´„æ±Ÿæ‘éµè·¯è‡ªè¡Œè»Š (16:30 å ´æ¬¡)ã€‚\n4. [ç¾é‡‘] éŒ¢åŒ…æº–å‚™ 80,000 éŸ“å…ƒç¾é‡‘ (å°ˆä»˜è¨ˆç¨‹è»Šè²»)ã€‚\n5. [è­‰ä»¶] å‹™å¿…æ”œå¸¶è­·ç…§ã€‚",
                events: [
                    { id: "d4-e1", time: "09:17", location: "é¾å±±ç«™ (Yongsan)", category: "transport", note: "ğŸš„ å‹•ä½œï¼šæ­ä¹˜ ITX-é’æ˜¥è™Ÿå‡ºç™¼ (å»ºè­°è»Šä¸Šåƒæ—©é¤)ã€‚\nğŸ•’ æ™‚é–“ï¼šä¹˜è»Šç´„ 1 å°æ™‚ 23 åˆ†é˜\nğŸ’° ç¥¨åƒ¹ï¼šå–®ç¨‹ç´„ 9,800 éŸ“å…ƒ (ä¾†å›ç´„ 20,000 éŸ“å…ƒ)ã€‚", coords: [37.5298, 126.9647] },
                    { id: "d4-e2", time: "10:40", location: "æŠµé”æ˜¥å·ç«™ (Chuncheon)", category: "activity", note: "ğŸ“ å‹•ä½œï¼šå‰å¾€ 1 è™Ÿå‡ºå£ã€ŒTravel Islandã€æ«ƒæª¯ã€‚\nğŸ“‹ ä»»å‹™ï¼šå‡ºç¤ºè­·ç…§ã€æ ¸å°é ç´„è³‡æ–™ã€‚", coords: [37.8844, 127.7171] },
                    { id: "d4-e3", time: "11:00", location: "è¨ˆç¨‹è»ŠåŒ…è»Šå•Ÿå‹•", category: "transport", note: "ğŸš• æŒ‡ä»¤ï¼šæº–æ™‚ä¸Šè»Šã€‚(ç›®æ¨™æ§åˆ¶ 5 å°æ™‚ï¼Œé ç®— 7 è¬éŸ“å…ƒ)", coords: [37.8844, 127.7171] },
                    { id: "d4-e4", time: "11:40", location: "å¹¸ç¦è‰åŸç‰§å ´ (90åˆ†é˜)", category: "activity", note: "ğŸ•’ åœç•™ï¼š1.5 å°æ™‚ (çˆ¬å¡æ‹å°ç‘å£«çµ•æ™¯ã€ä¸‹å±±é¤µç¶¿ç¾Š)", coords: [37.9472, 127.6703] },
                    { id: "d4-e5", time: "13:35", location: "é¦¬éˆ´è–¯éºµåŒ… (25åˆ†é˜)", category: "food", note: "ğŸ¥¡ æŒ‡ä»¤ï¼šå¤–å¸¶æ¨¡å¼ (Takeout Only)ã€‚\nâš ï¸ é‡é»ï¼šåªæ‹ç…§ï¼‹è²·éºµåŒ…å¤–å¸¶ï¼Œä¸å…§ç”¨ã€‚(çœæ™‚é—œéµ)", coords: [37.9255, 127.7812] },
                    { id: "d4-e6", time: "14:20", location: "æ˜æ´è¾£ç‚’é›æ’è¡— (60åˆ†é˜)", map_term: "Myeongdong Dakgalbi Street", category: "food", note: "ğŸ•’ åœç•™ï¼š1 å°æ™‚ (å¾å®¹äº«ç”¨åˆé¤)\nâš ï¸ æ­»ç·š (GATE)ï¼š15:25 å¿…é ˆä¸Šè»Šé›¢é–‹ï¼Œå‰å¾€è»Šç«™ã€‚", tags: ["æ­»ç·š"], coords: [37.8797, 127.7283] },
                    { id: "d4-e7", time: "15:45", location: "æŠµé”é‡‘è£•è²ç«™ (Gimyujeong)", map_term: "Gimyujeong Station", category: "transport", note: "ğŸ›‘ å‹•ä½œï¼šè¨ˆç¨‹è»Šä»»å‹™çµæŸã€‚\nğŸ’° ä»˜æ¬¾ï¼šæ”¯ä»˜ç¾é‡‘ç´„ 70,000 éŸ“å…ƒçµ¦å¸æ©Ÿ (å«è¶…æ™‚è²»)ã€‚", tags: ["ç¾é‡‘"], coords: [37.8164, 127.7135] },
                    { id: "d4-e8", time: "15:45", location: "å ±åˆ°ç·©è¡ (45åˆ†é˜)", category: "alert", note: "ğŸš» å‹•ä½œï¼šä¸Šå»æ‰€ã€æ›å¯¦é«”ç¥¨ã€16:10 å‰æŠµé”æ­ä¹˜å€é›†åˆã€‚", coords: [37.8164, 127.7135] },
                    { id: "d4-e9", time: "16:30", location: "æ±Ÿæ‘éµè·¯è‡ªè¡Œè»Š (å¤•é™½å ´)", category: "activity", note: "ğŸ•’ é«”é©—ï¼šç´„ 1.5 å°æ™‚ (é¨è¡Œ50åˆ† + ç«è»Š20åˆ† + æ¥é§è»Š)\nâš ï¸ æ™‚é–“æ¨ç®—ï¼šç´„ 18:00 å›åˆ°é‡‘è£•è²ç«™ã€‚", coords: [37.8164, 127.7135] },
                    { id: "d4-e10", time: "18:15", location: "åœ°éµç§»å‹•", category: "transport", note: "ğŸš‡ å‹•ä½œï¼šæ­ä¹˜äº¬æ˜¥ç·šåœ°éµ (å¾€æ˜¥å·æ–¹å‘) å 1 ç«™ã€‚", coords: [37.8164, 127.7135] },
                    { id: "d4-e11", time: "18:25", location: "æŠµé”å—æ˜¥å·ç«™", map_term: "Namchuncheon Station", category: "transport", note: "â˜• å‹•ä½œï¼šå‡ºç«™ä¼‘æ¯ã€è²·é›¶é£Ÿå€™è»Šã€‚", coords: [37.8638, 127.7239] },
                    { id: "d4-e12", time: "18:56", location: "å›ç¨‹é¦–çˆ¾ (ITX-é’æ˜¥è™Ÿ é›™ç­æ¬¡å‚™æ¡ˆ)", category: "transport", note: "ğŸš„ ã€Plan Aï¼šé¦–é¸ã€‘å—æ˜¥å· 18:56 ç™¼ â” 20:11 æŠµé”é¾å±±\n   *(å¹³æ—¥æ™šé–“ç‚º 1 å°æ™‚ä¸€ç­ï¼Œé€™æ˜¯éŠœæ¥æœ€å®Œç¾çš„ç­æ¬¡)*\nğŸš„ ã€Plan Bï¼šå‚™æ¡ˆã€‘å—æ˜¥å· 19:56 ç™¼ â” 21:14 æŠµé”é¾å±±\n   *(è‹¥éŒ¯é Plan A éœ€ç­‰ 1 å°æ™‚ï¼Œå»ºè­°åœ¨è»Šç«™é™„è¿‘åƒæ™šé¤)*\nğŸ’° ç¥¨åƒ¹ï¼šå–®ç¨‹ç´„ 9,800 éŸ“å…ƒã€‚", coords: [37.5298, 126.9647] }
                ]
            },
            {
                date: "06/05 (äº”) Day 5",
                title: "èˆå ‚é†«ç¾(3.5h)ï¼‹è–æ°´æ´(5h)",
                lunch: "çƒ¤é»¨ (è–æ°´åº—)", lunchId: "d5-e5", tea: "_______", teaId: null, dinner: "è–æ°´é¦¬éˆ´è–¯æ’éª¨æ¹¯", dinnerId: "d5-e7",
                events: [
                    { id: "d5-e1", time: "10:15", location: "äº¤é€šï¼šé¾å±± â” èˆå ‚ (é†«ç¾)", category: "transport", note: "ğŸ’³ åœ°éµï¼š4è™Ÿç·š [æ–°é¾å±±] â” [èˆå ‚]", coords: [37.4765, 126.9816] },
                    { id: "d5-e2", time: "11:00", location: "èˆå ‚é†«ç¾ç™‚ç¨‹", category: "activity", note: "ğŸ•’ é ä¼°åœç•™ï¼š3 ~ 3.5 å°æ™‚ (å«è«®è©¢ã€éº»é†‰ã€æ–½ä½œã€ä¿®å¾©)", coords: [37.4765, 126.9816] },
                    { id: "d5-e3", time: "14:30", location: "ç™‚ç¨‹çµæŸï¼Œæº–å‚™ç§»å‹•", category: "alert", note: "", coords: null },
                    { id: "d5-e4", time: "14:40", location: "äº¤é€šï¼šèˆå ‚ â” è–æ°´ (çƒ¤é»¨)", category: "transport", note: "ğŸ’³ åœ°éµï¼š2è™Ÿç·š [èˆå ‚] â” [è–æ°´] (ç´„ 40 åˆ†é˜)", coords: [37.5445, 127.0560] },
                    { id: "d5-e5", time: "15:20", location: "åˆæ™šé¤ï¼šçƒ¤é»¨ (è–æ°´åº—)", map_term: "Kkudang Seongsu", category: "food", note: "âš ï¸ æé†’ï¼šäººæ°£ååº—ï¼Œé›–å‰›é–‹é–€ä½†é€±äº”ä»å¯èƒ½éœ€å€™ä½\n*å›  15:00 ç¬¬ä¸€æ‰¹å‰›å…¥å ´ï¼Œè‹¥å®¢æ»¿å¯èƒ½éœ€ç­‰ç¬¬ä¸€è¼ªç”¨é¤çµæŸ\n*ç­–ç•¥ï¼šå…ˆå»ç™»è¨˜å€™ä½ (Catchtable)ï¼Œè‹¥éœ€ä¹…å€™å‰‡å…ˆé€›è¡—", coords: [37.5428, 127.0543] },
                    { id: "d5-e6", time: "ä¸‹åˆ", location: "è–æ°´æ´é€›è¡— (æ­¥è¡Œç¯„åœå¤§ï¼Œå»ºè­°ç©¿å¥½èµ°çš„é‹)", category: "shopping", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 4 - 5 å°æ™‚ (å«ç”¨é¤ã€å’–å•¡å»³ã€é€›è¡—)", coords: [37.5445, 127.0560] },
                    { id: "d5-e7", time: "æ™šé¤", location: "è–æ°´é¦¬éˆ´è–¯æ’éª¨æ¹¯ (æˆ– å’–å•¡å»³ç”œé»)", map_term: "Seongsu Potato Soup", category: "food", note: "", coords: [37.5445, 127.0560] },
                    { id: "d5-e8", time: "20:30", location: "äº¤é€šï¼šè–æ°´ â” ä¹æ¨¹ ROKAUS é¾å±±", category: "transport", note: "ğŸš• å»ºè­°ï¼šè¨ˆç¨‹è»Š (è¡“å¾Œå»ºè­°èˆ’é©ç§»å‹•)\nğŸ•’ æ™‚é–“ï¼šä¿®æ­£ä¼° 45-50 åˆ†é˜ (é€±äº”æ™šé–“å¡è»Šé¢¨éšªåŠ æ¬Š)\nğŸ’³ æ°£å€™å¡ï¼šåœ°éµè½‰ä¹˜ç´„ 45 åˆ†é˜ (è¼ƒç´¯ä½†æ™‚é–“ç©©)", coords: [37.5293, 126.9654] }
                ]
            },
            {
                date: "06/06 (å…­) Day 6",
                title: "å®‰åœ‹/ç›Šå–„æ´(4.5h)ï¼‹æ–°ç¾…å…ç¨…/å½ˆæ€§(2h)",
                lunch: "ç›Šå–„ç¿ éŸ¿/ç„¡æ‹›ç‰Œåº—", lunchId: "d6-e4", tea: "_______", teaId: null, dinner: "é›æ—è’œè¾£é›æ¹¯ (å‚™æ¡ˆ: ä¹™æ”¯ç²¾è‚‰)", dinnerId: "d6-e8",
                events: [
                    { id: "d6-e1", time: "09:00", location: "Catchtable é ç«¯å–è™Ÿ (Artist Bakery)", category: "alert", note: "", coords: null },
                    { id: "d6-e2", time: "10:00", location: "äº¤é€šï¼šé¾å±± â” å®‰åœ‹ç«™ (é¡¯å¿ æ—¥åœ°éµç‚ºä½³)", category: "transport", note: "ğŸ’³ æ°£å€™å¡ï¼šåœ°éµ 4è™Ÿç·š [æ–°é¾å±±] â” [å¿ æ­¦è·¯] è½‰ 3è™Ÿç·š â” [å®‰åœ‹]\nğŸ•’ æ™‚é–“ï¼šä¹˜è»Š+è½‰ä¹˜ç´„ 25 åˆ†é˜ (å‡æ—¥åœ°éµæœ€ç©©)", coords: [37.5766, 126.9854] },
                    { id: "d6-e3", time: "10:30", location: "ã€Artist Bakeryã€‘(é¹½éºµåŒ…å¤–å¸¶/é»å¿ƒ)", map_term: "Artist Bakery", category: "food", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 1 å°æ™‚ (å–è™Ÿ/è³¼è²·/ç°¡å–®åƒé»å¿ƒ)\nğŸ’¡ å‚™è¨»ï¼šè²·å®Œå¾Œå¯åœ¨å®‰åœ‹ç«™å‘¨é‚Šç¨ä½œä¼‘æ¯", coords: [37.5768, 126.9850] },
                    { id: "d6-e4", time: "12:00", location: "åˆé¤ï¼šäººæ°£ç¾©å¼æ–™ç†ã€äºŒé¸ä¸€ã€‘", category: "food", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 1.5 å°æ™‚ (å«æ’éšŠèˆ‡ç”¨é¤)\nâ¶ Ikseon Chwihyang (ç›Šå–„ç¿ éŸ¿)ï¼šç›Šå–„æ´å…§ï¼ŒéŸ“å¼å¾©å¤æ´‹é£Ÿ(è›‹åŒ…é£¯/ç¾©å¤§åˆ©éºµ)\nâ· Ganpan Eopneun Gage (ç„¡æ‹›ç‰Œåº—)ï¼šç›Šå–„æ´å…§ï¼ŒçŸ¥åç¾©å¤§åˆ©éºµ/ç‡‰é£¯(æ˜å¤ªå­/ç‰›æ’)", coords: [37.5744, 126.9905] },
                    { id: "d6-e5", time: "13:30", location: "ã€ç›Šå–„æ´éŸ“å±‹æ‘ã€‘(æ°›åœå’–å•¡å»³/æ–‡å‰µå°ç‰©)", category: "activity", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 1.5 å°æ™‚ (é€›è¡—èˆ‡æ‹ç…§)\nâ˜• æ¨è–¦ï¼šæ¸…æ°´å ‚ / æ¨‚åœ’é©›", coords: [37.5744, 126.9905] },
                    { id: "d6-e6", time: "15:15", location: "ã€ä¸‹åˆè¡Œç¨‹äºŒé¸ä¸€ã€‘(ä¾é«”åŠ›èˆ‡è³¼ç‰©éœ€æ±‚æ±ºå®š)", category: "activity", note: "â–¼ é¸é … Aï¼šä¸»æ”»å…ç¨…å“ (åŸå®šè¨ˆåŠƒ)\nğŸš• äº¤é€šï¼šè¨ˆç¨‹è»Šå‰å¾€æ–°ç¾…å…ç¨…åº— (ç´„ 20-25 åˆ†é˜)\nğŸ›ï¸ è¡Œç¨‹ï¼šæ–°ç¾…å…ç¨…åº— é¦–çˆ¾åº— (é ä¼°åœç•™ 2 å°æ™‚)\n\nâ–¼ é¸é … Bï¼šå½ˆæ€§è‡ªç”±æ™‚é–“ (å‚™æ¡ˆè³¼ç‰©/è£œé€›/ä¼‘æ¯)\nğŸ’¡ å»ºè­°ï¼šçºŒé€›ç›Šå–„æ´ã€å®‰åœ‹ç«™å‘¨é‚Šï¼Œæˆ–å‰å¾€æ˜æ´/ä¹™æ”¯è·¯\nâ˜• è¡Œç¨‹ï¼šæ‰¾é–“éŸ“å±‹å’–å•¡å»³ä¼‘æ¯ï¼Œæˆ–ææ—©å‰å¾€æ™šé¤å€åŸŸ", coords: [37.5562, 127.0084] },
                    { id: "d6-e7", time: "17:40", location: "äº¤é€šï¼šå‰å¾€é˜è·¯3è¡— (æ™šé¤)", category: "transport", note: "ğŸš• å»ºè­°ï¼šå¾æ–°ç¾…å‡ºç™¼ç´„ 15-20 åˆ†é˜ï¼›æˆ–å¾å‚™æ¡ˆåœ°é»æ­¥è¡Œå‰å¾€", coords: [37.5714, 126.9915] },
                    { id: "d6-e8", time: "18:00", location: "æ™šé¤ï¼šé›æ—è’œè¾£é›æ¹¯ (é›æ—é£Ÿå ‚ æœ¬åº— / ê³„ë¦¼ì‹ë‹¹)", map_term: "ê³„ë¦¼ì‹ë‹¹", category: "food", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 1.5 å°æ™‚\nğŸ“ ä½ç½®ï¼šé˜è·¯3è¡—ç«™ 12 è™Ÿå‡ºå£é™„è¿‘\nğŸ’¡ ã€å‚™æ¡ˆ Plan Bã€‘ä¹™æ”¯ç²¾è‚‰ (Eulji Jeong-yuk / ì„ì§€ì •ìœ¡)\n   *ä½ç½®ï¼šä¹™æ”¯è·¯3è¡—ç«™é™„è¿‘ (æ­¥è¡Œç´„ 5-8 åˆ†é˜)\n   *ç‰¹è‰²ï¼šéŸ“å¼çƒ¤è‚‰ (è‹¥ä¸æƒ³åƒè’œè¾£é›çš„æ›¿ä»£æ–¹æ¡ˆ)", coords: [37.5714, 126.9915] },
                    { id: "d6-e9", time: "20:00", location: "äº¤é€šï¼šé˜è·¯3è¡— â” ä¹æ¨¹ ROKAUS é¾å±±", category: "transport", note: "ğŸ’³ æ°£å€™å¡ï¼šåœ°éµ 1è™Ÿç·š [é˜è·¯3è¡—] â” [é¾å±±ç«™] (ç›´é”)\nğŸ•’ æ™‚é–“ï¼šä¹˜è»Šç´„ 12 åˆ†é˜ + æ­¥è¡Œå›é£¯åº— 5 åˆ†é˜", coords: [37.5293, 126.9654] }
                ]
            },
            {
                date: "06/07 (æ—¥) Day 7",
                title: "åˆäº•å‰ªé«®(4h)ï¼‹æœ›é /å¼˜å¤§/æ–°æ‘(4.5h)",
                lunch: "æœ›é å¸‚å ´å°åƒ", lunchId: "d7-e4", tea: "_______", teaId: null, dinner: "æ–°æ‘ å¥¶è¾£ç‡‰æ’éª¨", dinnerId: "d7-e8",
                events: [
                    { id: "d7-e1", time: "10:20", location: "äº¤é€šï¼šé¾å±± â” åˆäº• (åœ°éµè½‰ä¹˜æœ€é †)", category: "transport", note: "ğŸ’³ æ°£å€™å¡ï¼šåœ°éµ 4è™Ÿç·š [æ–°é¾å±±] â” [ä¸‰è§’åœ°] è½‰ 6è™Ÿç·š â” [åˆäº•]\nğŸ•’ æ™‚é–“ï¼šä¹˜è»Š+è½‰ä¹˜ç´„ 20-25 åˆ†é˜ (é£¯åº—é–€å£é€²ç«™ï¼Œè½‰ä¹˜1ç«™ï¼Œæœ€çœåŠ›)\nğŸš• å‚™æ¡ˆï¼šè¨ˆç¨‹è»Šç›´é”åˆäº• (ç´„ 15-20 åˆ†é˜ / 10,000 éŸ“å…ƒ)", coords: [37.5488, 126.9133] },
                    { id: "d7-e2", time: "11:00", location: "åˆäº•ç«™é«®å»Š", category: "activity", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 4 å°æ™‚ (å‰ª+æŸ“/ç‡™ï¼Œå«æºé€šæ™‚é–“)", coords: [37.5488, 126.9133] },
                    { id: "d7-e3", time: "15:00", location: "äº¤é€šï¼šåˆäº• â” æœ›é ", category: "transport", note: "ğŸ’³ åœ°éµ 6è™Ÿç·š (åƒ… 1 ç«™)\nğŸ•’ æ™‚é–“ï¼šä¹˜è»Š 2 åˆ†é˜ + æ­¥è¡Œè‡³å¸‚å ´ç´„ 5-8 åˆ†é˜", coords: [37.5561, 126.9064] },
                    { id: "d7-e4", time: "15:20", location: "æœ›é å¸‚å ´ (åƒé›¨è€³æ¨‚ç‚¸è¾£æ¤’ã€å¯æ¨‚é¤…)", category: "food", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 1.5 å°æ™‚ (åƒå°åƒ + é€›å¸‚å ´)", coords: [37.5561, 126.9064] },
                    { id: "d7-e6", time: "16:40", location: "äº¤é€šï¼šæœ›é  â” å¼˜å¤§", category: "transport", note: "ğŸ’³ æ°£å€™å¡ï¼šåœ°éµ 6è™Ÿç·šè½‰ 2è™Ÿç·š\nğŸ•’ æ™‚é–“ï¼šä¹˜è»Š+è½‰ä¹˜ç´„ 15 åˆ†é˜", coords: [37.5575, 126.9245] },
                    { id: "d7-e7", time: "17:00", location: "å¼˜å¤§å…¥å£ç«™ 8 è™Ÿå‡ºå£ (è—¥å±€/ç¾å¦)", category: "shopping", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 1.5 å°æ™‚ (å¿«é€Ÿè£œè²¨)", coords: [37.5575, 126.9245] },
                    { id: "d7-e7-transport", time: "19:00", location: "äº¤é€šï¼šå¼˜å¤§ â” æ–°æ‘ (æ™šé¤)", category: "transport", note: "ğŸš¶ æ­¥è¡Œï¼šæ²¿äº¬ç¾©ç·šæ›¸è¡—æ•£æ­¥ç´„ 15-20 åˆ†é˜\nğŸ’³ åœ°éµï¼š2è™Ÿç·š (1 ç«™) ç´„ 5 åˆ†é˜", coords: [37.5551, 126.9369] },
                    { id: "d7-e8", time: "19:30", location: "æ™šé¤ï¼šæ–°æ‘ å¥¶è¾£ç‡‰æ’éª¨", map_term: "ì†Œì‹ ì´ì˜", category: "food", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 1.5 å°æ™‚", coords: [37.5551, 126.9369] },
                    { id: "d7-e9", time: "21:00", location: "äº¤é€šï¼šæ–°æ‘ â” ä¹æ¨¹ ROKAUS é¾å±± (å›ç¨‹)", category: "transport", note: "ğŸ’¡ ç­–ç•¥ï¼šé€±æ—¥æ™šé–“å¼˜å¤§/æ–°æ‘å€æ˜“å¡è»Šï¼Œå»ºè­°å„ªå…ˆæ­åœ°éµ\nğŸš‡ åœ°éµï¼š2è™Ÿç·š [æ–°æ‘] â” [å¸‚å»³] è½‰ 1è™Ÿç·š â” [é¾å±±]\nğŸ•’ æ™‚é–“ï¼šå…¨ç¨‹ç´„ 25-30 åˆ†é˜ (æ™‚é–“æœ€ç©©ï¼Œå…å¡è»Š)\nğŸšŒ å…¬è»Šï¼šè—è‰²å·´å£« 750A / 750B / 752 (ç›´é”æ–°é¾å±±ç«™)\nğŸš• å‚™æ¡ˆï¼šè¨ˆç¨‹è»Š (è‹¥å¤ªç´¯ä¸æƒ³èµ°) ç´„ 20-25 åˆ†é˜ / 12,000 éŸ“å…ƒ", coords: [37.5293, 126.9654] }
                ]
            },
            {
                date: "06/08 (ä¸€) Day 8",
                title: "é¾å±±æœ€å¾Œæƒè²¨(4h)ï¼‹é‡‘æµ¦æ©Ÿå ´(3h)",
                lunch: "_______", lunchId: null, tea: "_______", teaId: null, dinner: "_______", dinnerId: null,
                events: [
                    { id: "d8-e1", time: "10:00", location: "æ•´ç†è¡Œæ & æº–å‚™ Check-out", category: "hotel", note: "", coords: [37.5293, 126.9654] },
                    { id: "d8-e2", time: "11:00", location: "è¾¦ç†é€€æˆ¿ (Check-out)", category: "hotel", note: "ğŸ§³ å‹•ä½œï¼šå°‡è¡Œæå¯„æ”¾åœ¨é£¯åº—æ«ƒå°", coords: [37.5293, 126.9654] },
                    { id: "d8-e3", time: "11:15", location: "ã€ç©ºçª—æœŸï¼š11:15-16:30ã€‘(æœ€å¾Œæƒè²¨)", category: "shopping", note: "ğŸ•’ å¯ç”¨æ™‚é–“ï¼šç´„ 4 - 5 å°æ™‚\nğŸ’¡ å»ºè­° Aï¼šEmart é¾å±±åº— (æ­¥è¡Œå¯é”)\nğŸ’¡ å»ºè­° Bï¼šiPark Mall (Gundam Base / Living Park)", coords: [37.5286, 126.9640] },
                    { id: "d8-e4", time: "16:30", location: "å›åˆ°é£¯åº—é ˜å–è¡Œæ", category: "hotel", note: "", coords: [37.5293, 126.9654] },
                    { id: "d8-e5", time: "17:00", location: "äº¤é€šï¼šä¹æ¨¹ ROKAUS é¾å±± â” é‡‘æµ¦æ©Ÿå ´ (GMP)", category: "transport", note: "ğŸš• å»ºè­°ï¼šè¨ˆç¨‹è»Š (å‹™å¿…é ç•™å¡è»Šç·©è¡)\nğŸ•’ æ™‚é–“ï¼šä¿®æ­£ä¼° 50-60 åˆ†é˜ (ä¸‹ç­å°–å³°æ™‚æ®µé¢¨éšª)\nğŸ’° è»Šè³‡ï¼šç´„ 25,000-30,000 éŸ“å…ƒ", coords: [37.5587, 126.8028] },
                    { id: "d8-e6", time: "17:50", location: "æŠµé”é‡‘æµ¦æ©Ÿå ´ & è¾¦ç†ç™»æ©Ÿ", category: "flight", note: "1. èˆªç©ºå…¬å¸æ«ƒæª¯ï¼šè¨—é‹è¡Œæ (Check-in)\n2. è¾¦ç†é€€ç¨… (Tax Refund)ï¼š\n   â€¢ æµ·é—œè“‹ç« ï¼š2æ¨“ 1 Gate é™„è¿‘\n   â€¢ ç¾é‡‘/æ«ƒå°ï¼š3æ¨“ 36 Gate é™„è¿‘ (æˆ–è‡ªåŠ©æ©Ÿ)\n*âš ï¸ è¨»ï¼šé‡‘æµ¦é€€ç¨…æ©Ÿé€šå¸¸åœ¨å®‰æª¢å‰ (2æ¨“)ï¼Œè‹¥éœ€äººå·¥æŸ¥é©—äº¦åŒ", coords: [37.5587, 126.8028] },
                    { id: "d8-e7", time: "18:30", location: "é€šéå®‰å…¨æª¢æŸ¥ & è­‰ç…§æŸ¥é©— (Immigration)", category: "alert", note: "ğŸ•’ é ä¼°æ™‚é–“ï¼šç´„ 20-30 åˆ†é˜ (è¦–ç¾å ´æ’éšŠç‹€æ³)", coords: null },
                    { id: "d8-e8", time: "19:00", location: "é ˜å–ç·šä¸Šå…ç¨…å“ & é ˜å–é€€ç¨…é‡‘", category: "shopping", note: "ğŸ•’ é ä¼°åœç•™ï¼šç´„ 50 åˆ†é˜ (åŒ…å«æ’éšŠèˆ‡æ•´ç†å…ç¨…å“)\nğŸ“ æè²¨ä½ç½®ï¼šé€šéå®‰æª¢å¾Œ (Airside) 3æ¨“ï¼Œ34è™Ÿç™»æ©Ÿé–€é™„è¿‘\n*è¨»ï¼šæ‰€æœ‰å…ç¨…åº— (æ–°ç¾…/æ¨‚å¤©ç­‰) çš†åœ¨åŒä¸€è™•ç¶œåˆæè²¨", coords: null },
                    { id: "d8-e9", time: "19:55", location: "ã€ç™»æ©Ÿæ™‚é–“ Boardingã€‘(èµ·é£›å‰ 40 åˆ†é˜)", category: "alert", note: "ğŸ“ å‹•ä½œï¼šå‰å¾€ç™»æ©Ÿé–€æº–å‚™æ’éšŠ\nâš ï¸ æé†’ï¼šè«‹ç¢ºä¿å·²é ˜å®Œå…ç¨…å“ï¼Œé¿å…å£“ç·šè¢«å»£æ’­", coords: null },
                    { id: "d8-e10", time: "20:35", location: "èµ·é£›è¿”ç¨‹ (å›é«˜é›„å°æ¸¯)", category: "flight", note: "Tigerair to KHH", coords: null },
                    { id: "d8-e11", time: "22:40", location: "æŠµé”é«˜é›„å°æ¸¯æ©Ÿå ´ (KHH)", category: "transport", note: "", coords: [22.5768, 120.3478] }
                ]
            }
        ];

        createApp({
            setup() {
                const showNotebook = ref(false);
                const showSync = ref(false);
                const settingsTab = ref('trips'); 
                const userNotes = ref("");
                const saveStatus = ref("Ready");
                const currentDayIndex = ref(0);
                const activeEventId = ref(null);
                const mapError = ref(false);
                
                const activeTripId = ref("");
                const countrySetting = ref("KR"); 
                const syncLoading = ref(false);
                const syncLog = ref(null);
                const tripLibrary = ref([]); 
                const initLoading = ref(false);
                const importJson = ref(""); 
                const aiPromptTemplate = ref(DEFAULT_AI_PROMPT);

                const schedule = ref(JSON.parse(JSON.stringify(DEFAULT_SCHEDULE)));
                const currentTripTitle = ref("Seoul Travel Guide");

                const timelineContainerRef = ref(null);
                const dayRefs = ref({});
                const openNoteBtn = ref(null);
                const noteTextarea = ref(null);
                const closeNoteBtn = ref(null);
                
                let map = null;
                let markersMap = new Map();
                let resizeObserver = null; 
                let resizeRaf = 0; 

                const currentTripId = computed(() => activeTripId.value);
                const currentDay = computed(() => schedule.value[currentDayIndex.value] || { date: '', title: '', events: [] });
                const displayEvents = computed(() => currentDay.value.events || []);
                const mapLegendItems = computed(() => {
                    const items = {};
                    Object.values(CATEGORY_CONFIG).forEach(c => { if(c.label !== 'Other') items[c.label] = c; });
                    return items;
                });
                
                const getStorageKey = (key) => {
                    // Unified key generation
                    const prefix = activeTripId.value || 'seoul2026';
                    return `${prefix}_${key}`;
                };

                const debounce = (fn, delay) => {
                    let timeoutId;
                    return (...args) => {
                        clearTimeout(timeoutId);
                        timeoutId = setTimeout(() => fn(...args), delay);
                    };
                };

                const escapeHtml = (text) => {
                    if (typeof text !== 'string') return text;
                    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                    return text.replace(/[&<>"']/g, (m) => map[m]);
                };

                const copyText = (text) => {
                    if (!text) return;
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text).catch(err => {
                            console.warn('Clipboard API failed', err);
                            fallbackCopy(text);
                        });
                    } else {
                        fallbackCopy(text);
                    }
                };

                const fallbackCopy = (text) => {
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        textArea.style.position = "fixed";
                        textArea.style.opacity = "0";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                    } catch (err) {}
                };

                const copyPrompt = () => {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(aiPromptTemplate.value)
                            .then(() => alert("Copied! Paste to Gemini with your image."))
                            .catch(err => fallbackCopy(aiPromptTemplate.value));
                    } else {
                        fallbackCopy(aiPromptTemplate.value);
                    }
                };

                const getCleanQuery = (rawLocation) => {
                    if (!rawLocation) return "";
                    let temp = rawLocation;
                    if (temp.includes('â”')) temp = temp.split('â”').pop().trim();
                    if (countrySetting.value === 'KR') {
                        const hangulRegex = /[\u3131-\uD79D]+/g;
                        const hangulMatches = temp.match(hangulRegex);
                        if (hangulMatches && hangulMatches.length > 0) return hangulMatches.join(' '); 
                    }
                    temp = temp.replace(/^(äº¤é€š|Transport|åˆé¤|Lunch|æ™šé¤|Dinner|åˆèŒ¶|Tea|ä½å®¿|Hotel)[ï¼š:]\s*/i, '');
                    temp = temp.replace(/\s*\((è¨ˆç¨‹è»Š|Taxi|åœ°éµ|Subway|å…¬è»Š|Bus|æ­¥è¡Œ|Walk|æ©Ÿå°|Kiosk|å¤–å¸¶|Takeout|Take-out|25åˆ†é˜|.*åˆ†é˜).*?\)/gi, '');
                    temp = temp.replace(/[ã€ã€‘]/g, ' ');
                    return temp.trim();
                };
                
                // Helper: Open map (used by Smart Links & Fallbacks)
                window.appOpenMap = (query) => {
                    const clean = getCleanQuery(query);
                    const provider = countrySetting.value;
                    let url = "";
                    if (provider === 'KR') {
                        url = `https://map.naver.com/p/search/${encodeURIComponent(clean)}`;
                    } else {
                        url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(clean)}`;
                    }
                    window.open(url, '_blank');
                };

                const openMapService = (event) => {
                    let query = "";
                    if (event.map_term) query = event.map_term;
                    else if (event.location) query = getCleanQuery(event.location);
                    if (query) window.appOpenMap(query);
                };

                const fitBounds = () => {
                    if (markersMap.size > 0 && map) {
                        const group = L.featureGroup(Array.from(markersMap.values()));
                        const isMobile = window.innerWidth < 768;
                        const paddingBottom = isMobile ? 20 : 50; 
                        map.fitBounds(group.getBounds(), { paddingTopLeft: [50, 50], paddingBottomRight: [50, paddingBottom], maxZoom: 14, animate: true });
                    }
                };

                const renderMarkers = () => {
                    if (!map) return;
                    markersMap.forEach(marker => { marker.off('click'); map.removeLayer(marker); });
                    markersMap.clear();
                    const events = displayEvents.value;
                    if (!events) return;
                    events.forEach((event) => {
                        if (event.coords) {
                            const config = CATEGORY_CONFIG[event.category] || CATEGORY_CONFIG.default;
                            const iconHtml = `<div class="custom-marker-pin" style="background-color: ${config.markerColor};"><div class="marker-icon-inner"></div></div>`;
                            const icon = L.divIcon({ className: 'custom-marker', html: iconHtml, iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -36] });
                            const marker = L.marker(event.coords, { icon: icon }).addTo(map);
                            const safeCategory = escapeHtml(event.category);
                            const safeLocation = escapeHtml(event.location);
                            const popupContent = `
                                <div class="font-sans p-1 min-w-[120px]">
                                    <div class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-widest">${safeCategory}</div>
                                    <div class="font-bold text-sm leading-tight text-[#2F2F2D]">${safeLocation}</div>
                                </div>`;
                            marker.bindPopup(popupContent, { closeButton: false, className: 'rounded-xl shadow-lg border-none', offset: [0, -5] });
                            marker.eventId = event.id;
                            marker.on('click', () => { focusEvent(event.id); });
                            markersMap.set(event.id, marker);
                        }
                    });
                    fitBounds();
                };

                let retryCount = 0;
                let tileErrorTimestamps = [];
                
                const initMap = () => {
                    // Safety check for Leaflet availability
                    if (typeof L === 'undefined') { 
                        if (retryCount < 20) { 
                            retryCount++; 
                            setTimeout(initMap, 500); 
                        } else { 
                            mapError.value = true; 
                        }
                        return; 
                    }
                    if (map) return; // Already initialized
                    
                    const mapDiv = document.getElementById('map');
                    if (!mapDiv) {
                        setTimeout(initMap, 300); // DOM not ready
                        return;
                    }

                    try {
                        map = L.map('map', { zoomControl: false, zoomAnimation: true, fadeAnimation: true }).setView([37.5665, 126.9780], 13);
                        const tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>', 
                            maxZoom: 20,
                            subdomains: 'abcd'
                        }).addTo(map);
                        
                        // Robust error handling for tiles
                        tileLayer.on('tileerror', () => { 
                            const now = Date.now();
                            tileErrorTimestamps = tileErrorTimestamps.filter(t => now - t < 15000); 
                            tileErrorTimestamps.push(now);
                            if (tileErrorTimestamps.length >= 20) { 
                                console.error("Map tile issues detected."); 
                                mapError.value = true; 
                            }
                        });
                        tileLayer.on('load', () => { tileErrorTimestamps = []; });
                        
                        renderMarkers();
                        
                        // Resize Observer to fix flex layout issues
                        resizeObserver = new ResizeObserver(() => { 
                            if (resizeRaf) cancelAnimationFrame(resizeRaf);
                            resizeRaf = requestAnimationFrame(() => { if(map) map.invalidateSize(); });
                        });
                        resizeObserver.observe(mapDiv);
                    } catch (e) {
                        console.error("Map init error:", e);
                        mapError.value = true;
                    }
                };
                
                const retryMap = () => { 
                    mapError.value = false;
                    retryCount = 0;
                    if (map) { map.remove(); map = null; markersMap.clear(); }
                    nextTick(() => { initMap(); });
                };

                // --- Interactions ---
                const selectDay = (index) => {
                    currentDayIndex.value = index;
                    activeEventId.value = null;
                    if(timelineContainerRef.value) timelineContainerRef.value.scrollTop = 0;
                    nextTick(() => {
                        const btn = dayRefs.value[index];
                        if (btn) btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        renderMarkers();
                    });
                };

                const focusEvent = (id) => {
                    activeEventId.value = id;
                    const event = displayEvents.value.find(e => e.id === id);
                    if (event && event.coords && map) {
                        markersMap.forEach((marker, mId) => {
                            const icon = marker.getElement();
                            if (!icon) return;
                            if (mId === id) { icon.classList.add('active'); marker.openPopup(); } 
                            else { icon.classList.remove('active'); marker.closePopup(); }
                        });
                        map.flyTo(event.coords, 16, { animate: true, duration: 1.2, easeLinearity: 0.25 });
                    }
                    // Auto-scroll to event card
                    nextTick(() => {
                        const el = document.getElementById('event-' + id);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                };

                // --- NEW FUNCTION: Robust Meal Map Logic (ID-based) ---
                const openMealMap = (type) => {
                    const day = currentDay.value;
                    const name = day[type];
                    const id = day[type + 'Id']; // Look for lunchId, teaId...

                    if (!name || name.includes('_______')) return;

                    // Blocklist: Prevent searching for generic terms if no ID
                    const blocklist = ['æ©Ÿä¸Š', 'è‡ªç†', 'å¤–é€', 'æ³¡éºµ', 'è¶…å•†', 'æ©Ÿå ´'];
                    if (!id && blocklist.some(k => name.includes(k))) {
                        // Optional: Show toast or just ignore
                        console.log("Blocked generic search:", name);
                        return;
                    }

                    // 1. ID Direct Link (The Robust Way)
                    if (id) {
                        focusEvent(id);
                        return;
                    }

                    // 2. Fallback: Name Search (Legacy)
                    window.appOpenMap(name);
                };

                // --- Interactions (Notebook & Sync) ---
                const openNotebook = () => { 
                    showNotebook.value = true;
                    nextTick(() => { if (noteTextarea.value) noteTextarea.value.focus(); });
                };

                const closeNotebook = () => {
                    showNotebook.value = false;
                    nextTick(() => { if (openNoteBtn.value) openNoteBtn.value.focus(); });
                };
                
                const saveNotes = debounce((e) => {
                    saveStatus.value = "Saving...";
                    try {
                        const keyPrefix = getStorageKey('data');
                        const dataToSave = { notes: userNotes.value, schedule: schedule.value };
                        localStorage.setItem(keyPrefix, JSON.stringify(dataToSave));
                        saveStatus.value = "Saved";
                        setTimeout(() => { if(saveStatus.value === 'Saved') saveStatus.value = 'Ready'; }, 2000);
                    } catch(err) {
                        console.error("Save failed", err);
                        saveStatus.value = "Error";
                    }
                }, 800);

                const trapFocus = (e) => {
                    if (!showNotebook.value) return;
                    const focusable = [noteTextarea.value, closeNoteBtn.value].filter(el => el);
                    const first = focusable[0];
                    const last = focusable[focusable.length - 1];
                    if (e.shiftKey) { if (document.activeElement === first) { last.focus(); e.preventDefault(); } } 
                    else { if (document.activeElement === last) { first.focus(); e.preventDefault(); } }
                };

                const handleGlobalKeydown = (e) => {
                    if (e.key === 'Escape') {
                        if (showNotebook.value) closeNotebook();
                        if (showSync.value) showSync.value = false;
                    }
                };

                const resetMap = () => {
                   if (map) {
                       map.flyTo([37.5665, 126.9780], 13, { animate: true, duration: 1 });
                       markersMap.forEach(marker => {
                           const icon = marker.getElement();
                           if(icon) icon.classList.remove('active');
                           marker.closePopup();
                       });
                       activeEventId.value = null;
                   }
                };

                // --- Validation ---
                const validateSchedule = () => {
                    schedule.value.forEach(day => {
                        ['lunch', 'tea', 'dinner'].forEach(type => {
                            const idKey = type + 'Id';
                            const eventId = day[idKey];
                            if (eventId) {
                                const event = day.events.find(e => e.id === eventId);
                                if (!event || !['food', 'shopping', 'activity', 'hotel', 'flight', 'transport'].includes(event.category)) {
                                    // Relaxed check: Allow almost all categories to be linked if ID is valid
                                    console.warn(`Invalid Meal ID removed: ${eventId} in ${day.date}`);
                                    day[idKey] = null; 
                                }
                            }
                        });
                    });
                };

                // --- Sync Logic ---
                const fetchTripLibrary = async () => {
                    if (!GAS_API_URL) {
                        syncLog.value = { type: 'error', message: 'API URL Not Configured' };
                        return;
                    }
                    syncLoading.value = true;
                    syncLog.value = { type: 'info', message: 'Fetching library...' };
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);

                    try {
                        const response = await fetch(`${GAS_API_URL}?action=list`, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const result = await response.json();
                        if (result.status === 'success') {
                            tripLibrary.value = result.trips;
                            syncLog.value = { type: 'success', message: 'Updated' };
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (e) {
                        syncLog.value = { type: 'error', message: 'Fetch Failed' };
                    } finally {
                        syncLoading.value = false;
                    }
                };

                const loadTrip = async (tripId) => {
                    if (!GAS_API_URL) return;
                    syncLoading.value = true;
                    syncLog.value = { type: 'info', message: `Loading ${tripId}...` };
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);

                    try {
                        const response = await fetch(`${GAS_API_URL}?action=load&tripId=${encodeURIComponent(tripId)}`, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            const data = JSON.parse(result.data);
                            activeTripId.value = tripId;
                            schedule.value = data.schedule || DEFAULT_SCHEDULE;
                            userNotes.value = data.notes || "";
                            currentTripTitle.value = data.meta?.title || tripId;
                            countrySetting.value = data.meta?.country || (tripId.includes('SEOUL') ? 'KR' : 'GLOBAL');
                            localStorage.setItem('activeTripId', tripId);
                            saveNotes(); 
                            validateSchedule(); // Validate on load
                            selectDay(0);
                            syncLog.value = { type: 'success', message: 'Loaded!' };
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (e) {
                        syncLog.value = { type: 'error', message: 'Load Failed' };
                    } finally {
                        syncLoading.value = false;
                    }
                };

                const saveTrip = async () => {
                    if (!GAS_API_URL) {
                        alert("API URL not configured in code.");
                        return;
                    }
                    if (!activeTripId.value) {
                        alert("Please enter a Trip ID first.");
                        return;
                    }
                    syncLoading.value = true;
                    syncLog.value = { type: 'info', message: 'Backing up...' };

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);

                    try {
                        const payload = {
                            tripId: activeTripId.value,
                            meta: { 
                                title: currentTripTitle.value, 
                                dateRange: schedule.value[0]?.date || 'Unknown Date',
                                country: countrySetting.value
                            },
                            data: JSON.stringify({ notes: userNotes.value, schedule: schedule.value })
                        };

                        const response = await fetch(GAS_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify(payload),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const result = await response.json();

                        if (result.status === 'success') {
                            syncLog.value = { type: 'success', message: 'Backup Saved!' };
                            fetchTripLibrary();
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (e) {
                        syncLog.value = { type: 'error', message: 'Backup Failed' };
                    } finally {
                        syncLoading.value = false;
                    }
                };

                const executeImport = () => {
                    try {
                        if (!importJson.value) return;
                        const data = JSON.parse(importJson.value);
                        if (Array.isArray(data)) {
                            schedule.value = data; 
                            alert("Schedule imported! Please save to backup.");
                        } else if (data.schedule) {
                            schedule.value = data.schedule; 
                            if(data.notes) userNotes.value = data.notes;
                            alert("Full trip data imported! Please save to backup.");
                        } else {
                             throw new Error("Invalid format");
                        }
                        validateSchedule(); // Validate on import
                        selectDay(0);
                        saveNotes();
                        importJson.value = ""; 
                    } catch(e) {
                        alert("Import failed: Invalid JSON format.");
                    }
                };
                
                const fetchSystemConfig = async () => {
                      if (!GAS_API_URL) return;
                      try {
                        const response = await fetch(`${GAS_API_URL}?action=load&tripId=__sys_prompt__`);
                        const result = await response.json();
                        if (result.status === 'success' && result.data) {
                            const configData = JSON.parse(result.data);
                            if (configData.prompt) aiPromptTemplate.value = configData.prompt;
                        }
                      } catch(e) {}
                };

                const autoFetchTrip = async (tripId) => {
                    if (!GAS_API_URL) return;
                    initLoading.value = true;
                    try {
                        const response = await fetch(`${GAS_API_URL}?action=load&tripId=${encodeURIComponent(tripId)}`);
                        const result = await response.json();
                        if (result.status === 'success') {
                            const data = JSON.parse(result.data);
                            schedule.value = data.schedule || schedule.value; 
                            currentTripTitle.value = data.meta?.title || tripId;
                            countrySetting.value = data.meta?.country || countrySetting.value;
                            validateSchedule(); // Validate on auto-fetch
                        }
                    } catch (e) {
                        console.warn("Auto-fetch failed", e);
                    } finally {
                        initLoading.value = false;
                    }
                };

                // --- Formatters ---
                const getDotColor = (cat) => ''; // Handled by Tailwind/CSS classes for markers
                const getCategoryBadge = (cat) => (CATEGORY_CONFIG[cat] || CATEGORY_CONFIG.default).icon;
                const getTagStyle = (tag) => {
                    if (tag === 'æ­»ç·š' || tag === 'é¢¨éšª') return 'bg-s-alert/20 text-s-alert';
                    if (tag === 'é—œéµ') return 'bg-s-warn/20 text-s-warn';
                    if (tag === 'ç¾é‡‘') return 'bg-s-green/20 text-s-green';
                    return 'bg-m-border text-m-sub';
                };

                const formatNote = (note) => {
                    if (!note) return '';
                    let processed = escapeHtml(note);
                    processed = processed.replace(REGEX_NEWLINE, '<br>');
                    processed = processed.replace(REGEX_KEYWORDS, '<span class="font-bold text-typo-title bg-yellow-100 px-1 rounded">$1</span>');
                    processed = processed.replace(/([0-9,]+)\s*(éŸ“å…ƒ|å…ƒ|KRW)/g, '<span class="font-mono font-bold text-s-green">$1 $2</span>');
                    processed = processed.replace(/([0-9]{2}:[0-9]{2})/g, '<span class="font-mono font-bold text-typo-title bg-gray-100 px-1 rounded">$1</span>');
                    
                    // Smart Links Removed per request
                    
                    return processed;
                };

                // --- Lifecycle ---
                onMounted(async () => {
                    try {
                        const lastTripId = localStorage.getItem('activeTripId');
                        if (lastTripId) {
                            activeTripId.value = lastTripId;
                            const savedData = localStorage.getItem(`${lastTripId}_data`);
                            if (savedData) {
                                const parsed = JSON.parse(savedData);
                                userNotes.value = parsed.notes || "";
                                if (parsed.schedule) schedule.value = parsed.schedule;
                            }
                            if (GAS_API_URL) await autoFetchTrip(lastTripId);
                        } else {
                             const saved = localStorage.getItem('seoul2026_data');
                             if (saved) {
                                 const parsed = JSON.parse(saved);
                                 userNotes.value = parsed.notes || "";
                             }
                             activeTripId.value = "SEOUL_2026";
                        }
                        
                        validateSchedule(); // Initial validation
                        await fetchSystemConfig();

                        const checkMap = () => { if (document.getElementById('map')) initMap(); else setTimeout(checkMap, 100); };
                        nextTick(checkMap);
                        window.addEventListener('keydown', handleGlobalKeydown);
                    } catch (e) {
                        console.error("App mount failed:", e);
                    }
                });

                onUnmounted(() => {
                    if (map) { map.remove(); map = null; }
                    if (resizeObserver) { resizeObserver.disconnect(); resizeObserver = null; }
                    if (resizeRaf) cancelAnimationFrame(resizeRaf);
                    window.removeEventListener('keydown', handleGlobalKeydown);
                });

                return {
                    schedule, currentDay, currentDayIndex, activeEventId, showNotebook, showSync, settingsTab,
                    tripId: activeTripId, activeTripId, currentTripId, currentTripTitle, syncLoading, syncLog,
                    tripLibrary, initLoading, importJson, userNotes, saveStatus, displayEvents, mapError,
                    timelineContainerRef, dayRefs, mapLegendItems, openNoteBtn, noteTextarea, closeNoteBtn,
                    selectDay, focusEvent, openNotebook, closeNotebook, saveNotes, resetMap, retryMap, copyText,
                    getDotColor, getCategoryBadge, getTagStyle, formatNote, trapFocus, openMapService, openMealMap,
                    fetchTripLibrary, loadTrip, saveTrip, executeImport, aiPromptTemplate, copyPrompt, countrySetting,
                    validateSchedule
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
